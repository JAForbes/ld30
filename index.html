<link rel='stylesheet' href='css/style.css'>
<img id='energy_ball' src='img/energyball.png'></img>
<img id='wormhole' src='img/wormhole.png'></img>
<img id='warlock' src='img/warlock.png'><img>
<img id='tree' src='img/tree.png'></img>
<img id='wizard' src='img/wizard_idle.png' repeat='true' playspeed='0.033'></img>
<img src='img/wizard_cast.png' repeat='false' playspeed='0.33'></img>
<img src='img/wizard_hurt.png' repeat='true' playspeed='0.33'></img>
<img id='villagers' src='img/villagers.png' repeat='true' playspeed='0.33'></img>
<div class='villager_count'>
    <p>0 Villagers Saved</p>
</div>
<div class='credits'>
    <p>Precipice - <a href='https://twitter.com/james_a_forbes/'>James Forbes</a></p>
</div>
<center>
	<canvas id='can'></canvas>
</center>

<script src='lib/underscore.js'></script>
<script src='lib/underscore_mixins.js'></script>
<script src='lib/o.js'></script>
<script src='lib/e.js'></script>
<script src='lib/jquery.js'></script>
<script src='lib/frame.js'></script>
<script>

function now(){
    return new Date().getTime()
}
</script>
<script>

gameID = E({
	Canvas: { el: can, width: 1, height: 1, con: can.getContext('2d') },
	Mouse: { x: can.width/2, y: can.height/2, },
	Paused: { paused: false },
	Screen: { width: 0, height: 0},
    Score: {},
})



home = E({
    Position: {x: can.width/2, y:can.height/2},
    Velocity: {x: 0,y:0},
    LockPosition: {position: 'center'},
    Strength: o({ strength: 150 }),
    Arc: { radius: 150, ratio: 0, theta: { start:0 , end: 2*Math.PI} },
    Frame: {scale:10 , playspeed: 1/5, frame: new Frame().reset(wormhole) },
    GestureShoot: {},
    DamageOnCollision: { inCircle: true },
    FrameScale: { component: 'Strength', key: 'strength', multiplier: 0.07 },
    StrengthLose: { min: 50},
})

defender = E({
    Position: {x: can.width/2, y:can.height/2},
    LockPosition: {position: 'center'},
    Frame: {scale:3 , playspeed: 1/10, frame: new Frame().reset(wizard) },
    State: {action:'idle'},
    MouseState: { down: 'cast' },
    Strength: E('Strength',home)
})

E('Strength',defender).change(function(){
  var state = E('State',defender);
  state.action = 'hurt';
  _.delay(function(){
    state.action = 'idle';
  },200)
})

shield = E({
    Arc : { radius: 0, ratio: 0, theta: { start: 0, end: 0} },
    GestureShield: { protect: home },
    Position: E('Position',home),
    Strength: o({ strength: 0 }),
    DamageOnCollision: { inCircle: true, inArc: true },
})


E({
    SpawnClock: {

        positions : function(){
            return [
                {x: 100, y: 100},
                {x: can.width - 100, y: 100},
                {x: 100, y: can.height - 100},
                {x: can.width - 100, y: can.height - 100},
                {x: 100 , y: can.height /2},
                {x: can.width-100, y: can.height /2},

            ]
        },
        clock: 100,
        spawnRate: 100,

    }
})

E({
    SpawnVillagers: { clock: 900, rate: 1000 }
})


function updateScreen(){
    var $el = $(window);
    var w = $el.width()
    var h = $el.height();
    var screen = E('Screen',gameID)
    screen.width = w;
    screen.height = h;
    setTimeout(drawTrees,200)
}

$(window).resize(updateScreen)
updateScreen()


function drawTrees() {
    E('Tree').each(function(tree,e){
        E.remove(e)
    });
    var n = 25;
    var angle = 2*Math.PI /n
    var offsetX = can.width /2;
    var offsetY = can.height/1.5;
    var xScale = can.width/2;
    var yScale = can.height/2
    _(n).times(function(i){

      var x = Math.cos(i*angle) * xScale + offsetX;
      var y = Math.sin(i*angle) * yScale + offsetY;

      E({
        Position: {x:x,y:y},
        Frame: {scale:y/(can.width/20), playspeed: 1/5, frame: new Frame().reset(tree) },
        Tree: {}
      })
      return [x,y]
    })
}



can.onmousemove = function (e) {
	var mouse = E('Mouse',gameID);
	mouse.x = e.offsetX
    mouse.y = e.offsetY
}

can.onmousedown = function(e){
    var mouse = E('Mouse',gameID);
    mouse.down = true;
}

can.onmouseup = function(e){
    var mouse = E('Mouse',gameID);
    mouse.down = false;
}



</script>
<script src='js/systems.js'></script>
<script src='js/game.js'></script>

